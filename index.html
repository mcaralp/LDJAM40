<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>La péninsule la plus à l'est, C'est ça le secret! (plus ou moins)</title>

</head>
    <script src="js/pixi.min.js"></script>
    <script src="js/load.js"></script>
    <script src="js/iso.js"></script>
    <script src="js/blocks.js"></script>
    <script src="js/layer.js"></script>
    <script src="js/player.js"></script>
    <script src="js/map.js"></script>
<body>
    <script type="text/javascript">
        
        let lastMovement = 0;
        function start()
        {
            const screenWidth  = 800;
            const screenHeight = 600;
          
            document.addEventListener("keydown", updateKeys);
            document.addEventListener("keyup", stopKeys);
            
            function sortBlocks(a, b)  
            {
                if(a.zIndex < b.zIndex) return -1;
                if(a.zIndex > b.zIndex) return 1;
              
                
                return 0;
            }
          
            function updateKeys(event)
            {
                lastMovement = event.keyCode;

                console.log('start');
            }
            
            function stopKeys(event)
            {                
                if(event.keyCode == lastMovement)
                {
                    console.log('stop');
                    lastMovement = 0;
                }
            }

            function update(delta)
            {
                let oldZ = player.z;
                player.move(lastMovement, map);                                                
                container.children.sort(sortBlocks);

                if(oldZ != player.z)
                    map.setCurrentLayer(player.z);

                let pos = player.getPosition();

                container.x = ((screenWidth / 2) - pos.x); 
                container.y = ((screenHeight / 2) - pos.y); 
            }

            //Create the renderer
            let app = new PIXI.Application(screenWidth, screenHeight, {backgroundColor : 'black'});
            document.body.appendChild(app.view);
            
            let bg = new PIXI.Sprite(PIXI.loader.resources.background);
            app.stage.addChild(bg);
    
            app.ticker.add(update);

            /*
            let isoCube = PIXI.Sprite.fromImage('images/placeholder.png');
            isoCube.anchor.set(0.5);

            isoCube.x = screenWidth / 2;
            isoCube.y = screenHeight / 2;
            */

            let map = ressources["map1"];
            let player = new Player();
            player.setMap(map);
          
            let container = new PIXI.Container(); 

            map.addToStage(container);
            player.addToStage(container);


            map.setCurrentLayer(player.z);

          
            container.children.sort(sortBlocks);

            app.stage.addChild(container);
  
        }
        
        loadAll(start);
 
    </script>
</body>
</html>
