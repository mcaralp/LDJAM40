<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>La péninsule la plus à l'est, C'est ça le secret! (plus ou moins)</title>

</head>
    <script src="js/pixi.min.js"></script>
    <script src="js/load.js"></script>
    <script src="js/iso.js"></script>
    <script src="js/blocks.js"></script>
    <script src="js/layer.js"></script>
    <script src="js/player.js"></script>
    <script src="js/orb.js"></script>
    <script src="js/map.js"></script>
<body>
    <script type="text/javascript">
        
        let lastMovement = 0;
        let action = false;

        function start()
        {
            const screenWidth  = 800;
            const screenHeight = 600;
          
            document.addEventListener("keydown", updateKeys);
            document.addEventListener("keyup", stopKeys);
            
            function sortBlocks(a, b)  
            {
                if(a.zIndex < b.zIndex) return -1;
                if(a.zIndex > b.zIndex) return 1;
              
                
                return 0;
            }
          
            function updateKeys(event)
            {
                if(event.keyCode >= 37 && event.keyCode <= 40)
                    lastMovement = event.keyCode;

                if(event.keyCode == 32)
                    action = true;
            }
            
            function stopKeys(event)
            {                
                if(event.keyCode == lastMovement)
                {
                    lastMovement = 0;
                }
            }

            function update(delta)
            {
                let oldZ = player.z;
                if(player.move(lastMovement, map))
                {
                    // TODO: update water

                }
                
                map.updateLayers(player.z);

                let pos = player.getPosition();

                container.x = ((screenWidth / 2) - pos.x); 
                container.y = ((screenHeight / 2) - pos.y); 

                container.children.sort(sortBlocks);

                let winned = 0;

                for(let i = 0; i < orbs.length; ++i)
                {
                    if(orbs[i].isDrowned())
                        orbs[i].goTo(orbs[i].states.destroyed);

                    if(orbs[i].isWinned())
                        ++winned;
                }

                if(winned == orbs.length)
                {
                    // TODO: end of level
                }

                if(player.isDrowned)
                {
                    // TODO game over
                }

                if(action)
                    player.action();

                action = false;
            }

            //Create the renderer
            let app = new PIXI.Application(screenWidth, screenHeight, {backgroundColor : 'black'});
            document.body.appendChild(app.view);
            
            let bg = new PIXI.Sprite(PIXI.loader.resources.background.texture);
            app.stage.addChild(bg);
    
            app.ticker.add(update);


            let map = ressources["map1"];
            let orbs = [];

            let player = new Player(map, orbs);

            

            for(let i = 0; i < map.orbs.length; ++i)
                orbs.push(new Orb(map, i));
            
          
            let container = new PIXI.Container(); 


            map.addToStage(container);
            player.addToStage(container);
            for(let i = 0; i < map.orbs.length; ++i)
                orbs[i].addToStage(container);

            app.stage.addChild(container);
  
        }
        
        loadAll(start);
 
    </script>
</body>
</html>
